# 互动同步功能测试指南

## 概述
本指南用于测试点赞和评论的跨设备同步功能，确保不同在线时长的设备都能正确同步最近3天的互动数据。

## 测试环境准备

### 1. 启动开发服务器
```bash
npm install
npm run dev
```

### 2. 准备测试账号
- 需要至少 2 个测试账号（或使用相同账号在不同浏览器/设备）
- 建议使用相同的中继服务器配置

### 3. 配置中继
在设置页面配置相同的 Nostr 中继服务器，例如：
- wss://relay.damus.io
- wss://relay.nostr.band
- wss://nos.lol

## 测试场景

### 场景 1: 新设备首次登录
**目的**: 验证新设备能获取最近3天的互动

**步骤**:
1. 在设备 A 上登录账号 A
2. 发布几条帖子
3. 在设备 B 上登录账号 B
4. 在设备 B 上对账号 A 的帖子进行点赞和评论
5. 清除设备 A 的浏览器缓存或使用隐私模式
6. 在设备 A 上重新登录账号 A
7. 等待数据加载完成

**预期结果**:
- ✅ 设备 A 应该显示账号 B 的点赞和评论
- ✅ 点赞数和评论数应该正确显示
- ✅ 控制台日志应显示成功回填互动事件

**检查点**:
- 查看浏览器控制台，应该看到类似以下日志：
  ```
  开始回填互动事件 (最近3天): since=...
  将回填 X 个帖子的互动
  回填互动过滤器 1/2: targeted at user
  回填互动过滤器 2/2: on specific events
  互动事件回填完成: 获取 X 条, 处理 Y 条
  ```

### 场景 2: 离线设备重新上线
**目的**: 验证离线设备重新上线后能同步最近3天的互动

**步骤**:
1. 在设备 A 上登录账号 A，发布帖子
2. 关闭设备 A 的浏览器（模拟离线）
3. 在设备 B 上登录账号 B
4. 在设备 B 上对账号 A 的帖子点赞和评论
5. 等待至少 1 分钟（确保事件已传播到中继）
6. 在设备 A 上重新打开浏览器并登录账号 A

**预期结果**:
- ✅ 设备 A 应该显示离线期间的点赞和评论
- ✅ 互动数据应该完整，不丢失
- ✅ 时间戳应该正确显示

### 场景 3: 下拉刷新
**目的**: 验证下拉刷新功能能正确同步最新互动

**步骤**:
1. 在设备 A 上登录并查看首页
2. 在设备 B 上对设备 A 可见的帖子进行新的点赞或评论
3. 在设备 A 上下拉刷新首页

**预期结果**:
- ✅ 刷新后应该看到新的点赞或评论
- ✅ 刷新过程应该流畅，有加载动画
- ✅ 不应该出现重复的互动

### 场景 4: 实时互动
**目的**: 验证实时订阅功能能即时显示新互动

**步骤**:
1. 在设备 A 上登录账号 A 并保持在首页
2. 在设备 B 上登录账号 B
3. 在设备 B 上对设备 A 可见的帖子进行点赞
4. 观察设备 A 的界面

**预期结果**:
- ✅ 设备 A 应该在几秒内看到新的点赞
- ✅ 点赞数应该自动更新
- ✅ 不需要刷新页面

### 场景 5: 多设备同时操作
**目的**: 验证多设备同时操作时的数据一致性

**步骤**:
1. 同时在设备 A 和设备 B 上登录相同账号
2. 在两个设备上同时对不同帖子进行点赞和评论
3. 在每个设备上下拉刷新

**预期结果**:
- ✅ 两个设备应该显示相同的互动数据
- ✅ 不应该有重复的点赞（同一用户对同一帖子只能点赞一次）
- ✅ 所有评论都应该正确显示

### 场景 6: 3天边界测试
**目的**: 验证只同步最近3天的互动

**步骤**:
1. 查看系统中是否有 3 天前的帖子
2. 如果没有，需要等待或手动创建测试数据
3. 登录并观察互动数据的时间范围

**预期结果**:
- ✅ 只显示最近3天内的互动
- ✅ 超过3天的互动不应该被回填
- ✅ 控制台日志应显示正确的时间范围

## 调试技巧

### 1. 查看控制台日志
打开浏览器开发者工具（F12），查看 Console 标签页：
- 搜索 "回填互动" 查看回填进度
- 搜索 "处理互动" 查看互动处理情况
- 搜索 "错误" 或 "失败" 查找问题

### 2. 检查本地存储
在开发者工具的 Application > Local Storage 中查看：
- `interactions_<pubkey>`: 存储的互动数据
- 检查 `lastSyncedAt` 时间戳是否正确更新

### 3. 监控网络请求
在开发者工具的 Network 标签页：
- 过滤 WebSocket 连接
- 观察与中继服务器的通信
- 检查是否有错误或超时

### 4. 验证过滤器
在控制台查看过滤器日志：
```
回填互动过滤器 1/2: targeted at user
回填互动过滤器 2/2: on specific events
```
确保两个过滤器都被执行

## 常见问题排查

### 问题 1: 互动不显示
**可能原因**:
- 中继服务器连接失败
- 事件加密/解密错误
- 时间戳不在3天窗口内

**排查步骤**:
1. 检查网络连接
2. 查看控制台是否有解密错误
3. 验证事件时间戳

### 问题 2: 重复的互动
**可能原因**:
- 防重复逻辑失效
- 多次回填相同数据

**排查步骤**:
1. 检查 `processedEvents` Set 是否正常工作
2. 查看是否有多次订阅或回填
3. 清除本地存储重新测试

### 问题 3: 性能问题
**可能原因**:
- 回填数据量过大
- 并行过滤器未生效

**排查步骤**:
1. 检查回填的事件数量
2. 验证 Promise.all 是否正确执行
3. 考虑调整 `maxBatches` 参数

## 测试清单

在完成测试后，请确认以下项目：

- [ ] 新设备首次登录能看到最近3天的互动
- [ ] 离线设备重新上线能同步最近3天的互动
- [ ] 下拉刷新能获取最新的互动数据
- [ ] 实时订阅能即时显示新互动
- [ ] 多设备同时操作数据一致
- [ ] 只同步最近3天的互动，不包括更早的数据
- [ ] 点赞和取消点赞功能正常
- [ ] 评论和回复功能正常
- [ ] 没有重复的互动显示
- [ ] 控制台没有错误日志
- [ ] 性能可接受（加载时间 < 10秒）

## 报告问题

如果发现问题，请提供以下信息：
1. 测试场景编号
2. 详细复现步骤
3. 预期结果 vs 实际结果
4. 控制台日志截图
5. 网络请求信息（如适用）
6. 浏览器和设备信息
